# 旅行支払い精算アプリ API設計書

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのバックエンドAPIの仕様を定義する

### 1.2 技術スタック
- **フレームワーク**: ASP.NET Core 8.0
- **認証**: JWT (JSON Web Token)
- **データベース**: SQL Server / PostgreSQL
- **ORM**: Entity Framework Core 8.0
- **API ドキュメント**: Swagger/OpenAPI 3.0

## 2. API 仕様

各機能グループごとの主要なエンドポイント定義です。

### 2.1 認証・認可
ユーザーの身元確認とアクセス権限の管理を行います。

| 機能名 | パス | メソッド | 成功時 | 概要 |
| :--- | :--- | :--- | :--- | :--- |
| ユーザー登録 | `/api/auth/register` | POST | 201 | 新規ユーザーを作成します。 |
| ログイン | `/api/auth/login` | POST | 200 | 認証を行い、アクセス用のトークンを発行します。 |
| トークン更新 | `/api/auth/refresh` | POST | 200 | リフレッシュトークンを用いて新しいトークンを発行します。 |

### 2.2 旅行管理
旅行の計画、メンバー、進捗を管理します。

| 機能名 | パス | メソッド | 成功時 | 概要 |
| :--- | :--- | :--- | :--- | :--- |
| 旅行一覧取得 | `/api/trips` | GET | 200 | 参加している旅行の一覧を検索条件に基づき取得します。 |
| 旅行詳細取得 | `/api/trips/{id}` | GET | 200 | 旅行の基本情報、メンバー、支払い履歴、精算状況を取得します。 |
| 旅行作成 | `/api/trips` | POST | 201 | 新しい旅行を作成し、指定されたメンバーを招待します。 |
| 旅行更新 | `/api/trips/{id}` | PUT | 200 | 旅行名、期間、予算、ステータスを変更します。 |
| 旅行削除 | `/api/trips/{id}` | DELETE | 204 | 旅行情報を削除します（管理者のみ）。 |

### 2.3 支払い管理
旅行中の支出を記録・管理します。

| 機能名 | パス | メソッド | 成功時 | 概要 |
| :--- | :--- | :--- | :--- | :--- |
| 支払い記録作成 | `/api/trips/{id}/payments` | POST | 201 | 旅行に紐づく新しい支払い（金額、カテゴリ、画像等）を記録します。 |
| 支払い記録更新 | `/api/payments/{id}` | PUT | 200 | 記録済みの支払い情報を修正します。 |
| 支払い記録削除 | `/api/payments/{id}` | DELETE | 204 | 支払い記録を削除します。 |
| 支払い一覧取得 | `/api/trips/{id}/payments` | GET | 200 | 旅行内の支払い履歴をフィルタリングして取得します。 |

### 2.4 精算管理
支払いデータに基づく個人間の貸し借りを解消します。

| 機能名 | パス | メソッド | 成功時 | 概要 |
| :--- | :--- | :--- | :--- | :--- |
| 精算計算 | `/api/trips/{id}/settlements/calculate` | GET | 200 | 現在の支払い状況から、誰が誰にいくら払うべきかを算出します。 |
| 精算完了登録 | `/api/trips/{id}/settlements` | POST | 201 | 個人間の精算が完了したことを記録します。 |

### 2.5 カテゴリ管理
支払いの分類項目を管理します。

| 機能名 | パス | メソッド | 概要 |
| :--- | :--- | :--- | :--- |
| カテゴリ一覧取得 | `/api/categories` | GET | 利用可能な支払いカテゴリ（食費、交通費等）の一覧を取得します。 |


## 3. 共通仕様

### 3.1 レスポンス形式
すべての API は一貫した構造でレスポンスを返却します。

| 項目 | 型 | 説明 |
| :--- | :--- | :--- |
| success | boolean | 処理の成否を示すフラグ。 |
| message | string | ユーザー向けの通知メッセージ。 |
| data | object/array | 処理結果の主要データ。 |
| errors | array | バリデーションエラーや詳細メッセージのリスト（失敗時）。 |
| statusCode | number | HTTP ステータスコード。 |

### 3.2 HTTP ステータスコード
API は標準的な HTTP ステータスコード (RFC 9110) を用いて状態を報告します。
- **200 (OK)**: データの取得、更新、成功。
- **201 (Created)**: リソースの新規作成成功。
- **204 (No Content)**: 削除などの成功（レスポンスボディなし）。
- **400 (Bad Request)**: リクエストパラメータの形式不備。
- **401 (Unauthorized)**: トークンが無効または未送信。
- **403 (Forbidden)**: 操作に必要な権限が不足。
- **404 (Not Found)**: 該当するリソースが存在しない。
- **422 (Unprocessable Entity)**: ビジネスルールや整合性のバリデーションエラー。
- **429 (Too Many Requests)**: レート制限によるリクエスト拒否 (RFC 6585)。
- **500 (Internal Server Error)**: サーバー内部の予期しないエラー。


## 4. 認証・認可

### 4.1 セキュリティ方式
- **方式**: HTTP `Authorization` ヘッダーを用いた JWT 認証を採用します。
- **スキーム**: RFC 6750 に従い、`Bearer` 認証スキームを使用します。
    - 例: `Authorization: Bearer <access_token>`
- **トークン構成**:
    - アクセストークン（短寿命）: 毎リクエストの認可に使用。
    - リフレッシュトークン（長寿命）: アクセストークンの再発行に使用。

### 4.2 アクセス権限ルール
旅行情報の操作は、旅行参加時のロールに基づいて制限されます。

- **管理者**: 旅行設定の変更、メンバー招待・削除、全データの操作が可能。
- **メンバー**: 自身の支払い記録の追加・編集、情報閲覧が可能。
- **閲覧者**: 旅行に関連するすべての情報の閲覧のみ可能。

## 5. 運用設計

### 5.1 レート制限
過剰なアクセスからシステムを保護するため、クライアント単位（IPまたはユーザー）で制限を設けます。
- **重要操作（ログイン等）**: 短時間に繰り返しの試行が不可能な低めの閾値を設定します。
- **一般API**: 通常の利用を妨げない範囲で、分間あたりのリクエスト数を制限します。

### 5.2 ログ・監視
問題の追跡とパフォーマンス管理のため、以下の情報を記録します。
- **API ログ**: アクセス日時、エンドポイント、処理時間、ステータスコード。
- **エラーログ**: 発生した例外のスタックトレースと発生コンテキスト。
- **監査ログ**: データの変更や権限の変更といった重要なセキュリティイベント。

---

*このAPI設計書は開発の進行に応じて更新される場合があります。*
