# 旅行支払い精算アプリ セキュリティ設計書

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのセキュリティ要件と実装方針を定義する

### 1.2 セキュリティ原則
- **Defense in Depth**: 多層防御によるセキュリティ確保
- **Principle of Least Privilege**: 最小権限の原則
- **Secure by Default**: デフォルトでセキュアな設定
- **Fail Securely**: 失敗時もセキュアな状態を維持
- **Security by Design**: 設計段階からのセキュリティ考慮

## 2. 脅威分析

### 2.1 主要な脅威

#### 2.1.1 認証・認可関連
- **認証バイパス**: 不正なログイン
- **権限昇格**: 不正な権限取得
- **セッションハイジャック**: セッションの乗っ取り
- **ブルートフォース攻撃**: パスワード推測

#### 2.1.2 データ関連
- **SQL インジェクション**: データベースへの不正アクセス
- **XSS（クロスサイトスクリプティング）**: 悪意のあるスクリプト実行
- **CSRF（クロスサイトリクエストフォージェリ）**: 不正なリクエスト送信
- **データ漏洩**: 機密情報の外部流出

#### 2.1.3 通信関連
- **中間者攻撃**: 通信の傍受・改ざん
- **リプレイ攻撃**: 通信の再送
- **DoS攻撃**: サービス拒否攻撃

### 2.2 リスク評価

| 脅威 | 発生確率 | 影響度 | リスクレベル | 対策優先度 |
|------|----------|--------|-------------|------------|
| 認証バイパス | 中 | 高 | 高 | 高 |
| SQL インジェクション | 低 | 高 | 中 | 高 |
| XSS | 中 | 中 | 中 | 中 |
| CSRF | 中 | 中 | 中 | 中 |
| データ漏洩 | 低 | 高 | 高 | 高 |
| 中間者攻撃 | 中 | 高 | 高 | 高 |


## 3. 認証・認可方針

システムの入り口となる認証と、操作権限の制御方針を定義します。

### 3.1 認証方式
- **技術選定**: 標準的なトークンベース認証（JWT: JSON Web Token）を採用します。
- **パスワード管理**: パスワードは平文で保存せず、業界標準の低速ハッシュアルゴリズム（PBKDF2、BCrypt等）を用い、ソルトを付与して保存します。ハッシュ化の試行回数（イテレーション）は、現代の計算機能力に合わせた十分な回数を設定します。
- **セッション管理**: トークンの有効期限を短く設定し、リフレッシュトークンを用いた再発行の仕組みを備えます。不正検知時には、サーバー側で特定のセッションを強制終了可能にします。

### 3.2 認可制御
- **ロールベースアクセス制御 (RBAC)**: 旅行内での役割（管理者、メンバー、閲覧者）に基づき、API レベルでの操作制限を行います。
- **所有権の検証**: 支払い記録などの個人データに対しては、操作ユーザーがそのデータの所有者であるか、または管理権限を持っているかを個別に検証します。


## 4. データセキュリティ方針

情報の完全性と機密性を維持するための。

### 4.1 データ暗号化
- **保存時暗号化**: データベースの機密項目やファイルストレージ上のデータに対し、AES等の強力な暗号化アルゴリズムを適用します。
- **鍵管理**: 暗号化キーはアプリケーションの設定ファイルには直接記述せず、クラウドプロバイダーのマネージド鍵管理サービス（Key Vault等）を利用して安全に管理します。

### 4.2 脆弱性対策
- **SQL インジェクション**: すべてのデータアクセスにおいて ORM またはパラメータ化クエリを使用し、動的な文字列結合によるクエリ生成を禁止します。
- **クロスサイトスクリプティング (XSS)**: 出力データの適切なエスケープ（サニタイズ）と、Content Security Policy (CSP) ヘッダーの活用により、悪意のあるスクリプト実行を防止します。
- **入力値検証**: すべての API リクエストにおいて、サーバーサイドでの厳格なバリデーションを実施します（型、長さ、形式、許可文字のチェック）。


## 5. 通信・セッションセキュリティ

### 5.1 ネットワークセキュリティ
- **トランスポート層保護 (TLS)**: すべての通信に HTTPS を強制し、TLS 1.2 以上の利用を必須とします。HSTS (HTTP Strict Transport Security) を設定し、非セキュアな接続を排除します。
- **CORS 設定**: 許可されたドメイン（信頼できるフロントエンド等）からのリクエストのみを受理するように制限します。

### 5.2 応答ヘッダーの強化
セキュリティを高める以下の HTTP レスポンスヘッダーを付与します。
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Referrer-Policy: strict-origin-when-cross-origin`


## 6. 運用・監視方針

### 6.1 ロギングと監査
セキュリティ上重要なイベントを永続的なログとして記録します。
- **イベント種類**: ログイン成否、パスワード変更、権限変更、不正アクセス試行。
- **記録項目**: タイムスタンプ、ユーザーID、IPアドレス、イベントの種類と詳細。

### 6.2 不正アクセス抑止
- **アカウントロック**: 一定回数のログイン失敗が発生した際、一時的にアカウントをロックまたは追加の検証（CAPTCHA等）を要求します。
- **レート制限**: API エンドポイントごとのアクセス頻度を制限し、ブルートフォース攻撃や DoS 攻撃を抑止します。


## 7. セキュリティ検証

開発サイクルの中で継続的なセキュリティ検証を実施します。

### 7.1 検証項目
- **静的解析 (SAST)**: コードスキャンにより脆弱なロジックを自動検出。
- **動的解析 (DAST)**: 実行中の API に対して疑似攻撃を実施し、レスポンスの妥当性を検証。
- **依存関係チェック**: 利用しているライブラリ等に既知の脆弱性が含まれていないか確認。

### 7.2 主要なテストケース
- 認証トークンなしでの非公開 API アクセス拒否。
- 別ユーザーのリソース（支払い記録等）に対する不正な更新・削除の拒否。
- 不正な形式の入力値（SQL インジェクション文字等）の遮断。


## 8. インシデント対応

セキュリティインシデント（情報漏洩、不正アクセス検知等）発生時の対応体制とフローを整備します。
- **検知と報告**: システムのアラートやユーザーからの報告に基づく初動対応。
- **封じ込め**: 不正なセッションの遮断やサービスの一次停止。
- **復旧**: 影響範囲の特定と修正済みデータのリストア。


### 9. インシデント対応手順

#### 9.1 インシデント検出
- **自動検出**: セキュリティログの監視
- **手動検出**: ユーザーからの報告
- **外部検出**: セキュリティ研究者からの報告

#### 9.2 インシデント対応フロー
1. **検出・報告**: インシデントの検出と報告
2. **初期対応**: 影響範囲の特定と初期対応
---

*このセキュリティ設計書は開発の進行に応じて更新される場合があります。*
