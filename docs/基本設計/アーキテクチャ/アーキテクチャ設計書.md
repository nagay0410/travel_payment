# 旅行支払い精算アプリ アーキテクチャ設計書

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのバックエンドアーキテクチャを定義する

### 1.2 設計原則
- **クリーンアーキテクチャ**: 依存関係の方向性を明確化
- **SOLID原則**: 保守性・拡張性の高い設計
- **セキュリティファースト**: 認証・認可を重視
- **パフォーマンス**: 高速なレスポンスを実現
- **スケーラビリティ**: 将来の拡張に対応

## 2. アーキテクチャパターン

### 2.1 クリーンアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Controllers │  │   Middleware │  │   Filters & Attributes │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Services   │  │   DTOs      │  │   Validators        │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Entities   │  │   Interfaces │  │   Domain Services   │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Repositories │  │   Database   │  │   External Services │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 レイヤー間の依存関係
- Presentation Layer → Application Layer
- Application Layer → Domain Layer
- Infrastructure Layer → Domain Layer
- **禁止**: Domain Layer → Infrastructure Layer

## 3. プロジェクト構造

### 3.1 ソリューション構成

```
TravelPayment.sln
├── src/
│   ├── API/                 # Web API プロジェクト
│   ├── Application/         # アプリケーション層
│   ├── Domain/              # ドメイン層
│   ├── Infrastructure/      # インフラストラクチャ層
│   └── Shared/              # 共通ライブラリ
├── tests/
│   ├── API/                 # API テスト
│   ├── Application/         # アプリケーション層テスト
│   ├── Domain/              # ドメイン層テスト
│   └── Infrastructure/      # インフラ層テスト
└── docs/                    # ドキュメント
```

### 3.2 各プロジェクトの詳細

#### 3.2.1 TravelPayment.API
- **役割**: HTTP エンドポイントの提供
- **主要コンポーネント**:
  - Controllers
  - Middleware
  - Filters
  - Program.cs (設定・DI設定)

#### 3.2.2 TravelPayment.Application
- **役割**: ビジネスロジックの実装
- **主要コンポーネント**:
  - Services
  - DTOs
  - Validators
  - Mappers
  - Interfaces

#### 3.2.3 TravelPayment.Domain
- **役割**: ビジネスルールとエンティティの定義
- **主要コンポーネント**:
  - Entities
  - Value Objects
  - Domain Services
  - Interfaces
  - Exceptions

#### 3.2.4 TravelPayment.Infrastructure
- **役割**: 外部サービスとの連携
- **主要コンポーネント**:
  - Repositories
  - Database Context
  - External Services
  - Configuration

## 4. ドメインモデル

システムの核となるビジネスエンティティと値オブジェクトを定義します。

### 4.1 共通基底属性
すべてのエンティティは、管理目的で以下の属性を共通して保持します。

| 属性名 | 説明 | 備考 |
| :--- | :--- | :--- |
| ID | エンティティを一意に識別する識別子 | GUID形式 |
| 作成日時 | レコードが作成された日時 | UTC |
| 更新日時 | レコードが最後に更新された日時 | UTC |

### 4.2 主要エンティティ

#### 4.2.1 User（ユーザー）
システムを利用するユーザー情報を管理します。

| 属性カテゴリ | 主要な属性 |
| :--- | :--- |
| 基本情報 | ユーザー名、メールアドレス、氏名 |
| セキュリティ | パスワードハッシュ、メール認証ステータス |
| 状態管理 | アクティブフラグ、最終ログイン日時、プロフィール画像 |

#### 4.2.2 Trip（旅行）
ユーザーが作成する旅行のグループを管理します。

| 属性カテゴリ | 主要な属性 |
| :--- | :--- |
| 基本情報 | 旅行名、説明、カバー画像 |
| 期間・予算 | 開始日、終了日、予算 |
| 状態管理 | ステータス（計画中、実行中、完了）、作成者ID |

#### 4.2.3 Payment（支払い）
旅行中に発生した個々の支払い記録を管理します。

| 属性カテゴリ | 主要な属性 |
| :--- | :--- |
| 支払い詳細 | 金額、通貨、カテゴリ、内容説明 |
| 付随情報 | 支払い日、領収書画像、位置情報 |
| 外貨対応 | 為替レート、精算済みフラグ |

### 4.3 値オブジェクト
特定の属性をカプセル化し、ドメインのルールを適用します。

- **Money（金額）**: 金額と通貨のセット。負の金額の禁止や通貨変換のルールを保持します。
- **DateRange（日付範囲）**: 開始日と終了日のセット。開始日が終了日より前であることの検証や、期間の計算ルールを保持します。


## 5. アプリケーションサービス

ユースケースに基づいたビジネスロジックの実行を担います。

### 5.1 主要サービス一覧

| サービス名 | 役割・機能概要 |
| :--- | :--- |
| 旅行管理サービス | 旅行の作成、詳細取得、一覧表示（ページング対応）、情報の更新、削除、メンバー追加・削除 |
| 支払い管理サービス | 支払い情報の記録、修正、削除、旅行ごとの支払い一覧表示 |
| 認証・ユーザーサービス | ユーザー登録、ログイン、プロフィール管理、トークン発行 |

### 5.2 処理共通ルール
- すべてのサービスメソッドは非同期処理として実装します。
- データの変更を伴う処理は、Unit of Work パターンを用いてトランザクション管理を行います。
- 実行前に、操作ユーザーの権限（認可）チェックおよび入力データのバリデーションを実施します。


## 6. リポジトリパターン

データアクセスの抽象化を行い、ドメイン層が特定のデータストア実装に依存しないようにします。

### 6.1 基本方針
- **インターフェース定義**: ドメイン層で定義し、必要なデータ操作を規定します。
- **実装**: インフラストラクチャ層で Entity Framework Core 等を用いて具体的なデータアクセスを実装します。
- **集約**: 基本的に集約ルート（Trip, User等）ごとにリポジトリを作成します。

### 6.2 標準的な操作
すべてのリポジトリは、以下の標準的な操作をサポートします。
- IDによる取得
- 全件取得
- ページング付き取得
- 新規追加、更新、削除


## 7. 認証・認可

システムのセキュリティを確保するための仕組みを定義します。

### 7.1 JWT認証
認証には JSON Web Token (JWT) を使用します。
- ログイン成功時にサーバーからクライアントへトークンを発行します。
- クライアントは以降のリクエストの Authorization ヘッダーにトークンを含めます。
- トークンにはユーザーID、ユーザー名、メールアドレスなどのクレームを含めます。

### 7.2 ロールベース認可
旅行データへのアクセスは、旅行内でのユーザーの役割（ロール）に基づいて制限します。

| ロール名 | 権限範囲 |
| :--- | :--- |
| 管理者 (Admin) | 旅行情報の変更、メンバー追加・削除、支払い記録の全操作 |
| メンバー (Member) | 自身の支払い記録の作成・変更、旅行情報の閲覧、他メンバーの支払い閲覧 |
| 閲覧者 (Viewer) | 情報の閲覧のみ可能 |


## 8. 例外処理

システム全体で一貫したエラーハンドリングとレスポンス形式を提供します。

### 8.1 主要なエラーコード

| エラーコード | 対応する状況 | HTTPステータス |
| :--- | :--- | :--- |
| NOT_FOUND | 指定されたリソースが見つからない | 404 |
| UNAUTHORIZED | 認証されていない、または権限がない | 401 |
| VALIDATION_ERROR | 入力データの形式やビジネスルールに違反 | 422 |
| INTERNAL_ERROR | 予期しないサーバー内部エラー | 500 |

### 8.2 レスポンス形式
エラー発生時は、以下の項目を含む JSON 形式でレスポンスを返却します。
- 成功フラグ（false）
- エラーメッセージ（ユーザー向け）
- エラー詳細（バリデーションエラーの詳細など）
- 内部エラーコード


## 9. ログ・監視

システムの安定稼働と問題解決のための仕組みを定義します。

### 9.1 ロギング方針
- **出力先**: 開発環境はコンソール、本番環境はクラウド監視サービス（Application Insights等）に出力します。
- **ログレベル**: 
    - Information: 主要なビジネスアクションの完了
    - Warning: パフォーマンス低下や軽微な問題
    - Error: 例外の発生、致命的なエラー
- **コンテキスト**: リクエストID、ユーザーID等を含め、追跡可能性を確保します。

### 9.2 パフォーマンス監視
- すべてのリクエストの処理時間を記録します。
- 閾値（例: 1000ms）を超えるリクエストについては、警告ログを出力し改善の対象とします。


## 10. 設定管理

アプリケーションの動作を制御する外部設定項目を管理します。

### 10.1 主要設定項目

| カテゴリ | 設定項目 | 用途 |
| :--- | :--- | :--- |
| データベース | ConnectionStrings | DB接続情報、リトライ回数、タイムアウト設定 |
| セキュリティ | JwtSettings | JWT署名キー、発行者、有効期限 |
| 外部連携 | CorsSettings | 許可するオリジン、メソッド、ヘッダー |
| 監視 | Logging | ログ出力レベル、外部サービス連携キー |

### 10.2 管理方針
- 環境ごとに設定ファイルを分離します（appsettings.Development.json 等）。
- 署名キーなどの機密情報は、環境変数やシークレット管理サービスを利用し、リポジトリには含めません。


## 11. 将来的な拡張性

### 11.1 ドメインイベントの導入
将来的に機能が複雑化し、一つのアクションが複数の後続処理（通知送信、ログ記録、外部連携等）を引き起こす場合、ドメインイベントの導入を検討します。

#### 11.1.1 導入の目的とメリット
- **関心事の分離**: 主要なビジネスロジックと、それに付随する二次的な処理を分離できます。
- **結合度の低減**: 処理の起点となるエンティティが、後続処理の内容を知る必要がなくなります。
- **拡張性向上**: 既存のコードを変更することなく、新しい後続処理（購読者）を追加できます。

#### 11.1.2 想定されるユースケース
- 旅行に新しいメンバーが追加された際の通知送信
- 支払い記録の作成に伴う、アクティビティログへの書き込み
- 旅行が完了ステータスに変更された際の、最終精算レポート作成のキック


---

*このアーキテクチャ設計書は開発の進行に応じて更新される場合があります。*