

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのデータベース設計を定義する

### 1.2 技術仕様
- **データベース**: SQL Server 2022 / PostgreSQL 15
- **ORM**: Entity Framework Core 8.0
- **マイグレーション**: EF Core Migrations
- **備考**: DB固有の関数（例: `GETUTCDATE()`, `NEWID()`）は、EF Coreの機能を用いて設定し、DBプロバイダーが各DBに適した関数（例: PostgreSQLの`now() at time zone 'utc'`, `gen_random_uuid()`）に変換することを想定する。
- **インデックス**: パフォーマンス最適化のための適切なインデックス設計

## 2. テーブル設計

### 2.1 Users（ユーザー情報）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| UserId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | ユーザーID |
| UserName | NVARCHAR(50) | NOT NULL, UNIQUE | ユーザー名 |
| Email | NVARCHAR(255) | NOT NULL, UNIQUE | メールアドレス |
| PasswordHash | NVARCHAR(255) | NOT NULL | パスワードハッシュ |
| FirstName | NVARCHAR(50) | NULL | 名 |
| LastName | NVARCHAR(50) | NULL | 姓 |
| ProfileImage | NVARCHAR(500) | NULL | プロフィール画像URL |
| IsActive | BIT | NOT NULL, DEFAULT 1 | アクティブフラグ |
| EmailVerified | BIT | NOT NULL, DEFAULT 0 | メール認証済みフラグ |
| LastLoginAt | DATETIME2 | NULL | 最終ログイン日時 |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 更新日時 |

**インデックス:**
- IX_Users_Email (Email)
- IX_Users_Username (Username)
- IX_Users_IsActive (IsActive)

### 2.2 Trips（旅行情報）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| TripId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | 旅行ID |
| TripName | NVARCHAR(100) | NOT NULL | 旅行名 |
| Description | NVARCHAR(1000) | NULL | 旅行の説明 |
| StartDate | DATE | NOT NULL | 開始日 |
| EndDate | DATE | NOT NULL | 終了日 |
| Budget | DECIMAL(18,2) | NULL | 予算 |
| Status | NVARCHAR(20) | NOT NULL, DEFAULT 'Planning' | ステータス |
| CoverImage | NVARCHAR(500) | NULL | カバー画像URL |
| CreatedBy | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 作成者ID |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 更新日時 |

**ステータス値:**
- Planning（計画中）
- Active（実施中）
- Completed（完了）
- Cancelled（キャンセル）

**制約:**
- `CHECK (Status IN ('Planning', 'Active', 'Completed', 'Cancelled'))`

**インデックス:**
- IX_Trips_CreatedBy (CreatedBy)
- IX_Trips_Status (Status)
- IX_Trips_StartDate (StartDate)
- IX_Trips_EndDate (EndDate)

### 2.3 TripMembers（旅行参加者）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| TripMemberId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | 旅行参加者ID |
| TripId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 旅行ID |
| UserId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | ユーザーID |
| Role | NVARCHAR(20) | NOT NULL, DEFAULT 'Member' | 役割 |
| JoinedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 参加日時 |
| IsActive | BIT | NOT NULL, DEFAULT 1 | アクティブフラグ |

**役割値:**
- Admin（管理者）
- Member（一般参加者）
- Viewer（閲覧者）

**制約:**
- `CHECK (Role IN ('Admin', 'Member', 'Viewer'))`

**インデックス:**
- IX_TripMembers_TripId (TripId)
- IX_TripMembers_UserId (UserId)
- IX_TripMembers_TripId_UserId (TripId, UserId) - UNIQUE

### 2.4 Categories（支払いカテゴリ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| CategoryId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | カテゴリID |
| CategoryName | NVARCHAR(50) | NOT NULL, UNIQUE | カテゴリ名 |
| Description | NVARCHAR(200) | NULL | カテゴリの説明 |
| Icon | NVARCHAR(50) | NULL | アイコン名 |
| Color | NVARCHAR(7) | NULL | カラーコード |
| IsDefault | BIT | NOT NULL, DEFAULT 0 | デフォルトカテゴリフラグ |
| SortOrder | INT | NOT NULL, DEFAULT 0 | 表示順序 |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 更新日時 |

**デフォルトカテゴリ:**
- 交通費
- 宿泊費
- 食費
- 娯楽費
- 買い物
- その他

**インデックス:**
- IX_Categories_CategoryName (CategoryName)
- IX_Categories_SortOrder (SortOrder)

### 2.5 Payments（支払い記録）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| PaymentId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | 支払いID |
| TripId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 旅行ID |
| PaidBy | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 支払い者ID |
| CategoryId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | カテゴリID |
| Amount | DECIMAL(18,2) | NOT NULL | 金額 |
| Description | NVARCHAR(500) | NOT NULL | 支払い内容 |
| PaymentDate | DATE | NOT NULL | 支払い日 |
| ReceiptImage | NVARCHAR(500) | NULL | レシート画像URL |
| Location | NVARCHAR(200) | NULL | 支払い場所 |
| Currency | NVARCHAR(3) | NOT NULL, DEFAULT 'JPY' | 通貨 |
| ExchangeRate | DECIMAL(10,6) | NULL | 為替レート |
| IsReimbursed | BIT | NOT NULL, DEFAULT 0 | 精算済みフラグ |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 更新日時 |

**インデックス:**
- IX_Payments_TripId (TripId)
- IX_Payments_PaidBy (PaidBy)
- IX_Payments_CategoryId (CategoryId)
- IX_Payments_PaymentDate (PaymentDate)
- IX_Payments_TripId_PaymentDate (TripId, PaymentDate)

### 2.6 Settlements（精算記録）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| SettlementId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | 精算ID |
| TripId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 旅行ID |
| FromUserId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 精算元ユーザーID |
| ToUserId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | 精算先ユーザーID |
| Amount | DECIMAL(18,2) | NOT NULL | 精算金額 |
| Status | NVARCHAR(20) | NOT NULL, DEFAULT 'Pending' | 精算ステータス |
| SettlementMethod | NVARCHAR(50) | NULL | 精算方法 |
| SettlementDate | DATE | NULL | 精算日 |
| Notes | NVARCHAR(500) | NULL | 備考 |
| CompletedAt | DATETIME2 | NULL | 完了日時 |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 更新日時 |

**ステータス値:**
- Pending（未精算）
- Completed（精算完了）
- Cancelled（キャンセル）

**制約:**
- `CHECK (Status IN ('Pending', 'Completed', 'Cancelled'))`

**精算方法:**
- Cash（現金）
- BankTransfer（振込）
- PayPay（PayPay）
- LINE Pay（LINE Pay）
- その他

**インデックス:**
- IX_Settlements_TripId (TripId)
- IX_Settlements_FromUserId (FromUserId)
- IX_Settlements_ToUserId (ToUserId)
- IX_Settlements_Status (Status)
- IX_Settlements_TripId_Status (TripId, Status)

### 2.7 UserSessions（ユーザーセッション）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| SessionId | UNIQUEIDENTIFIER | PRIMARY KEY, DEFAULT NEWID() | セッションID |
| UserId | UNIQUEIDENTIFIER | NOT NULL, FOREIGN KEY | ユーザーID |
| RefreshToken | NVARCHAR(500) | NOT NULL | リフレッシュトークン |
| ExpiresAt | DATETIME2 | NOT NULL | 有効期限 |
| IsActive | BIT | NOT NULL, DEFAULT 1 | アクティブフラグ |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |
| LastUsedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 最終使用日時 |

**インデックス:**
- IX_UserSessions_UserId (UserId)
- UQ_UserSessions_RefreshToken (RefreshToken) - UNIQUE
- IX_UserSessions_ExpiresAt (ExpiresAt)

## 3. リレーション設計

### 3.1 外部キー制約

```sql
-- Trips -> Users
ALTER TABLE Trips
ADD CONSTRAINT FK_Trips_CreatedBy
FOREIGN KEY (CreatedBy) REFERENCES Users(UserId) ON DELETE NO ACTION;

-- TripMembers -> Trips
ALTER TABLE TripMembers
ADD CONSTRAINT FK_TripMembers_TripId
FOREIGN KEY (TripId) REFERENCES Trips(TripId) ON DELETE CASCADE;

-- TripMembers -> Users
ALTER TABLE TripMembers
ADD CONSTRAINT FK_TripMembers_UserId
FOREIGN KEY (UserId) REFERENCES Users(UserId) ON DELETE CASCADE;

-- Payments -> Trips
ALTER TABLE Payments
ADD CONSTRAINT FK_Payments_TripId
FOREIGN KEY (TripId) REFERENCES Trips(TripId) ON DELETE CASCADE;

-- Payments -> Users
ALTER TABLE Payments
ADD CONSTRAINT FK_Payments_PaidBy
FOREIGN KEY (PaidBy) REFERENCES Users(UserId) ON DELETE NO ACTION;

-- Payments -> Categories
ALTER TABLE Payments
ADD CONSTRAINT FK_Payments_CategoryId
FOREIGN KEY (CategoryId) REFERENCES Categories(CategoryId) ON DELETE NO ACTION;

-- Settlements -> Trips
ALTER TABLE Settlements
ADD CONSTRAINT FK_Settlements_TripId
FOREIGN KEY (TripId) REFERENCES Trips(TripId) ON DELETE CASCADE;

-- Settlements -> Users (From)
ALTER TABLE Settlements
ADD CONSTRAINT FK_Settlements_FromUserId
FOREIGN KEY (FromUserId) REFERENCES Users(UserId) ON DELETE NO ACTION;

-- Settlements -> Users (To)
ALTER TABLE Settlements
ADD CONSTRAINT FK_Settlements_ToUserId
FOREIGN KEY (ToUserId) REFERENCES Users(UserId);

-- UserSessions -> Users
ALTER TABLE UserSessions
ADD CONSTRAINT FK_UserSessions_UserId
FOREIGN KEY (UserId) REFERENCES Users(UserId) ON DELETE CASCADE;
```

### 3.2 一意制約

```sql
-- TripMembers: 1つの旅行に同じユーザーは1回しか参加できない
ALTER TABLE TripMembers
ADD CONSTRAINT UQ_TripMembers_TripId_UserId
UNIQUE (TripId, UserId);

-- Users: ユーザー名とメールアドレスは一意
ALTER TABLE Users
ADD CONSTRAINT UQ_Users_Username
UNIQUE (Username);

ALTER TABLE Users
ADD CONSTRAINT UQ_Users_Email
UNIQUE (Email);

-- Categories: カテゴリ名は一意
ALTER TABLE Categories
ADD CONSTRAINT UQ_Categories_CategoryName
UNIQUE (CategoryName);

-- UserSessions: リフレッシュトークンは一意
ALTER TABLE UserSessions
ADD CONSTRAINT UQ_UserSessions_RefreshToken 
UNIQUE (RefreshToken);
```

## 4. ビュー設計

### 4.1 TripSummary（旅行サマリービュー）

```sql
CREATE VIEW TripSummary AS
SELECT 
    t.TripId,
    t.TripName,
    t.StartDate,
    t.EndDate,
    t.Budget,
    t.Status,
    COUNT(DISTINCT tm.UserId) AS MemberCount,
    COUNT(p.PaymentId) AS PaymentCount,
    COALESCE(SUM(p.Amount), 0) AS TotalPayments,
    t.CreatedBy,
    u.Username AS CreatedByUsername,
    t.CreatedAt
FROM Trips t
LEFT JOIN TripMembers tm ON t.TripId = tm.TripId AND tm.IsActive = 1
LEFT JOIN Payments p ON t.TripId = p.TripId
LEFT JOIN Users u ON t.CreatedBy = u.UserId
GROUP BY t.TripId, t.TripName, t.StartDate, t.EndDate, t.Budget, t.Status, t.CreatedBy, u.Username, t.CreatedAt;

-- 注意: このビューは複数のテーブルを結合するため、データ量が増加した際のパフォーマンスに注意が必要です。
-- EXPLAINプランを確認し、各テーブルのインデックス（IX_TripMembers_TripId, IX_Payments_TripIdなど）が
-- 効果的に利用されていることを確認することを推奨します。
```

### 4.2 UserPaymentSummary（ユーザー支払いサマリービュー）

```sql
CREATE VIEW UserPaymentSummary AS
SELECT 
    t.TripId,
    t.TripName,
    u.UserId,
    u.Username,
    COUNT(p.PaymentId) AS PaymentCount,
    COALESCE(SUM(p.Amount), 0) AS TotalPaid,
    tm.Role
FROM Trips t
JOIN TripMembers tm ON t.TripId = tm.TripId
JOIN Users u ON tm.UserId = u.UserId
LEFT JOIN Payments p ON t.TripId = p.TripId AND p.PaidBy = u.UserId
WHERE tm.IsActive = 1
GROUP BY t.TripId, t.TripName, u.UserId, u.Username, tm.Role;

-- 注意: このビューは複数のテーブルを結合するため、データ量が増加した際のパフォーマンスに注意が必要です。
-- EXPLAINプランを確認し、各テーブルのインデックスが効果的に利用されていることを確認することを推奨します。
```

## 5. ストアドプロシージャ

### 5.1 CalculateSettlements（精算計算）

```sql
CREATE PROCEDURE CalculateSettlements
    @TripId UNIQUEIDENTIFIER
AS
BEGIN
    SET NOCOUNT ON;
    
    -- 旅行の支払い総額と参加者数を取得
    DECLARE @TotalAmount DECIMAL(18,2);
    DECLARE @MemberCount INT;
    
    SELECT 
        @TotalAmount = COALESCE(SUM(p.Amount), 0),
        @MemberCount = COUNT(DISTINCT tm.UserId)
    FROM Trips t
    LEFT JOIN TripMembers tm ON t.TripId = tm.TripId AND tm.IsActive = 1
    LEFT JOIN Payments p ON t.TripId = p.TripId
    WHERE t.TripId = @TripId;
    
    -- 1人あたりの金額を計算
    DECLARE @PerPersonAmount DECIMAL(18,2) = @TotalAmount / @MemberCount;
    
    -- 各ユーザーの支払い状況を取得
    SELECT 
        u.UserId,
        u.Username,
        COALESCE(SUM(p.Amount), 0) AS TotalPaid,
        @PerPersonAmount AS PerPersonAmount,
        COALESCE(SUM(p.Amount), 0) - @PerPersonAmount AS Balance
    FROM TripMembers tm
    JOIN Users u ON tm.UserId = u.UserId
    LEFT JOIN Payments p ON tm.TripId = p.TripId AND p.PaidBy = u.UserId
    WHERE tm.TripId = @TripId AND tm.IsActive = 1
    GROUP BY u.UserId, u.Username;
END;
```

## 6. インデックス戦略

### 6.1 パフォーマンス最適化

```sql
-- 複合インデックス（よく使用されるクエリパターン）
CREATE INDEX IX_Payments_TripId_CategoryId_PaymentDate 
ON Payments (TripId, CategoryId, PaymentDate);

CREATE INDEX IX_Settlements_TripId_Status_CreatedAt 
ON Settlements (TripId, Status, CreatedAt);

CREATE INDEX IX_TripMembers_TripId_Role_IsActive 
ON TripMembers (TripId, Role, IsActive);

-- 全文検索用インデックス
CREATE FULLTEXT INDEX ON Trips (TripName, Description);
CREATE FULLTEXT INDEX ON Payments (Description);
```

## 7. データ移行・初期データ

### 7.1 初期カテゴリデータ

```sql
INSERT INTO Categories (CategoryId, CategoryName, Description, Icon, Color, IsDefault, SortOrder)
VALUES 
    (NEWID(), '交通費', '電車、バス、タクシー、レンタカー等', 'directions_car', '#2196F3', 1, 1),
    (NEWID(), '宿泊費', 'ホテル、旅館、民宿等', 'hotel', '#4CAF50', 1, 2),
    (NEWID(), '食費', '食事、飲み物、お土産等', 'restaurant', '#FF9800', 1, 3),
    (NEWID(), '娯楽費', '観光、アクティビティ、ショー等', 'attractions', '#9C27B0', 1, 4),
    (NEWID(), '買い物', 'お土産、記念品等', 'shopping_bag', '#E91E63', 1, 5),
    (NEWID(), 'その他', 'その他の費用', 'more_horiz', '#607D8B', 1, 6);
```

## 8. セキュリティ・バックアップ

### 8.1 セキュリティ設定
- データベースユーザーの最小権限原則
- 暗号化接続（TLS/SSL）
- 定期的なパスワード変更
- アクセスログの記録

### 8.2 バックアップ戦略
- フルバックアップ：日次
- 差分バックアップ：6時間ごと
- トランザクションログバックアップ：15分ごと
- 長期保存：月次（1年間）

---

*このデータベース設計書は開発の進行に応じて更新される場合があります。*