

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのデータ保持構造と管理方針を定義する。

### 1.2 設計方針
- **データの整合性**: 外部キー制約等を用い、旅行、参加者、支払いの関係性を厳格に管理する。
- **パフォーマンス**: 頻繁にアクセスされる検索条件に対し、適切な索引（インデックス）を付与する。
- **抽象化**: データベースエンジンの差異を吸収するため、アプリケーション層では ORM (Entity Framework Core) を介した論理的なデータ操作を行う。

## 2. データ構造定義

### 2.1 ユーザー情報 (Users)
システムを利用するユーザーと、その認証状態を管理します。

| 属性名 | 論理型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| UserId | ID | 必須, 一意 | ユーザーを一意に識別する内部ID。 |
| UserName | 文字列 | 必須, 一意 | ログイン等に使用するユーザー名。 |
| Email | 文字列 | 必須, 一意 | 連絡・認証用のメールアドレス。 |
| PasswordHash | 文字列 | 必須 | セキュアにハッシュ化されたパスワード。 |
| 状態・日時 | 日時, フラグ | - | 作成日時、最終ログイン、有効フラグ等。 |

### 2.2 旅行情報 (Trips)
ユーザーが作成する旅行のグループ定義です。

| 属性名 | 論理型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| TripId | ID | 必須, 一意 | 旅行を一意に識別するID。 |
| TripName | 文字列 | 必須 | 旅行の名称。 |
| 期間 | 日付 | 必須 | 旅行の開始日および終了日。 |
| Status | 文字列 | 必須 | 旅行の状態（計画中、実施中、完了、中止）。 |
| CreatedBy | ID | 必須 | 旅行を作成したユーザーのID。 |

### 2.3 旅行参加者 (TripMembers)
旅行とユーザーの紐づけ（多対多の解決）と権限を管理します。

| 属性名 | 論理型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| TripId | ID | 必須 | 所属する旅行のID。 |
| UserId | ID | 必須 | 参加するユーザーのID。 |
| Role | 文字列 | 必須 | 旅行内での役割（管理者、メンバー、閲覧者）。 |
| IsActive | フラグ | 必須 | 現在その旅行に参加しているかどうかの状態。 |

### 2.4 支払い記録 (Payments)
旅行中に発生した具体的な支出データを保持します。

| 属性名 | 論理型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| TripId | ID | 必須 | 支払いが紐づく旅行のID。 |
| PaidBy | ID | 必須 | 支払いを行ったユーザーのID。 |
| CategoryId | ID | 必須 | 支払いの種類（食費、交通費等）。 |
| Amount | 数値 | 必須 | 支払い金額。 |
| Currency | 文字列 | 必須 | 通貨単位（デフォルトはJPY）。 |
| PaymentDate | 日付 | 必須 | 支払いが発生した日。 |

### 2.5 精算記録 (Settlements)
個人間の支払い残高解消プロセスを管理します。

| 属性名 | 論理型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| TripId | ID | 必須 | 精算を行う旅行のID。 |
| FromUserId | ID | 必須 | 支払いを行う側のユーザーID。 |
| ToUserId | ID | 必須 | 受け取る側のユーザーID。 |
| Amount | 数値 | 必須 | 精算する合計金額。 |
| Status | 文字列 | 必須 | 精算の状態（未精算、精算済み）。 |

## 3. 関連・整合性ルール

### 3.1 主要なリレーション関係
- **旅行と参加者**: 一つの旅行には複数のユーザーが参加し、一人のユーザーは複数の旅行に参加可能です。
- **旅行と支払い**: 支払いは必ず特定の旅行に紐づきます。旅行が削除された場合、関連する支払い記録も削除対象となります。
- **支払いとユーザー**: 各支払い記録には「誰が支払ったか」の情報が必須であり、ユーザーが削除されても支払い記録は精算のために維持される必要があります（論理削除推奨）。

### 3.2 整合性制約
- **一意性**: メールアドレス、ユーザー名、旅行内のユーザー参加（同一旅行に二重参加不可）は一意である必要があります。
- **期間の妥当性**: 旅行の開始日は終了日以前である必要があります。
- **ステータス遷移**: 精算記録は「未精算」から「精算済み」への遷移のみを許可し、完了後の修正は原則禁止します。

## 4. 抽出・集計ロジック

複雑な検索や精算計算のための主要なロジック方針です。

### 4.1 旅行サマリー (TripSummary)
旅行ごとの基本情報に加え、参加人数、支払い件数、支払い合計額をリアルタイムまたはキャッシュを用いて算出します。

### 4.2 精算計算 (CalculateSettlements)
特定の旅行における全員の支払い合計を算出し、参加人数で割ることで「一人あたりの負担額」を求めます。各個人の「実際の支払い額」との差分から、不足しているユーザーと過剰に支払っているユーザーを特定し、精算ルートを生成します。

## 5. 索引（インデックス）方針

パフォーマンスを確保するため、以下の観点でインデックスを設計します。
- **検索キー**: メールアドレス、ユーザー名、旅行名などの頻繁な検索対象。
- **外部キー**: 旅行ID、ユーザーIDなどの結合（JOIN）に使用されるカラム。
- **範囲検索**: 支払い日や旅行期間、作成日時など、順序に基づいた取得を行うカラム。


## 6. 運用・バックアップ方針

### 6.1 バックアップ戦略
- **頻度**: 日次でのフルバックアップに加え、要件に応じた差分・ログバックアップを実施します。
- **保管場所**: 地理的に冗長なストレージへの保管を検討し、災害対策（DR）を考慮します。

### 6.2 データパージ・アーカイブ
- **セッション情報**: 有効期限の切れた古いセッションデータは、定期的なバッチ処理により削除します。
- **完了した旅行**: 完了から一定期間（例: 2年以上）経過した旅行データについては、アーカイブ用ストレージへの移動または削除のルールを策定します。

### 6.3 セキュリティ
- **アクセス制御**: 最小権限の原則に基づき、アプリケーション実行ユーザーは必要最低限のテーブル操作権限のみを保持します。
- **機密データ**: パスワードなどの機密情報は、DB内でも適切なハッシュ化・暗号化状態で保持します。

---

*このデータベース設計書は開発の進行に応じて更新される場合があります。*