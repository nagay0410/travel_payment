# テーブル詳細設計書

## 1. 共通設計
全てのテーブルには、以下の共通カラムを保持させる。

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 作成日時 | CreatedAt | DATETIMEOFFSET | DateTimeOffset | NOT NULL | レコードの作成日時 (UTC) |
| 更新日時 | UpdatedAt | DATETIMEOFFSET | DateTimeOffset | NOT NULL | レコードの最終更新日時 (UTC) |

## 2. テーブル定義

### 2.1 Users (ユーザー)
物理名: `Users`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| ユーザーID | UserId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | ユーザーを一意に識別するID |
| ユーザー名 | UserName | NVARCHAR(50) | string | UNIQUE, NOT NULL | ログインに使用する名前 |
| メールアドレス | Email | NVARCHAR(256) | string | UNIQUE, NOT NULL | 連絡・認証用のメールアドレス |
| パスワードハッシュ | PasswordHash | NVARCHAR(MAX) | string | NOT NULL | ハッシュ化されたパスワード |
| 最終ログイン日時 | LastLoginAt | DATETIMEOFFSET | DateTimeOffset? | - | 最終ログイン日時 |
| 有効フラグ | IsActive | BIT | bool | NOT NULL, Default: 1 | アカウントの有効状態 |

### 2.2 Trips (旅行)
物理名: `Trips`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 旅行ID | TripId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | 旅行を一意に識別するID |
| 旅行名 | TripName | NVARCHAR(100) | string | NOT NULL | 旅行の名称 |
| 説明 | Description | NVARCHAR(500) | string | - | 旅行の詳細説明 |
| 開始日 | StartDate | DATE | DateTime | NOT NULL | 旅行の開始日 |
| 終了日 | EndDate | DATE | DateTime | NOT NULL | 旅行の終了日 |
| 予算 | Budget | DECIMAL(18,2) | decimal? | - | 旅行の予算総額 |
| ステータス | Status | NVARCHAR(20) | string | NOT NULL | 状態 (Planning, Active, Completed) |
| 作成者ID | CreatedBy | UNIQUEIDENTIFIER | Guid | FK (Users.UserId), NOT NULL | 旅行を作成したユーザー |

### 2.3 TripMembers (旅行参加者)
物理名: `TripMembers`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 参加者管理ID | TripMemberId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | 参加レコード一意ID |
| 旅行ID | TripId | UNIQUEIDENTIFIER | Guid | FK (Trips.TripId), NOT NULL | 所属する旅行ID |
| ユーザーID | UserId | UNIQUEIDENTIFIER | Guid | FK (Users.UserId), NOT NULL | 参加するユーザーID |
| ロール | Role | NVARCHAR(20) | string | NOT NULL | Role (Admin, Member, Viewer) |
| 参加日時 | JoinedAt | DATETIMEOFFSET | DateTimeOffset | NOT NULL | 旅行に参加した日時 |
| 有効フラグ | IsActive | BIT | bool | NOT NULL, Default: 1 | 参加状態（退会・削除等） |

### 2.4 Categories (カテゴリ)
物理名: `Categories`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| カテゴリID | CategoryId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | カテゴリ一意ID |
| カテゴリ名 | CategoryName | NVARCHAR(50) | string | NOT NULL | カテゴリの名称 |
| 説明 | Description | NVARCHAR(200) | string | - | カテゴリの詳細説明 |
| アイコン | Icon | NVARCHAR(50) | string | - | アイコン識別子 (Material Icons等) |

### 2.5 Payments (支払い)
物理名: `Payments`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 支払いID | PaymentId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | 支払い一意ID |
| 旅行ID | TripId | UNIQUEIDENTIFIER | Guid | FK (Trips.TripId), NOT NULL | 支払いが紐づく旅行ID |
| 支払者ID | PaidBy | UNIQUEIDENTIFIER | Guid | FK (Users.UserId), NOT NULL | 支払いを行ったユーザーID |
| カテゴリID | CategoryId | UNIQUEIDENTIFIER | Guid | FK (Categories.CategoryId), NOT NULL | 支払いのカテゴリ |
| 金額 | Amount | DECIMAL(18,2) | decimal | NOT NULL | 支払い金額 |
| 通貨 | Currency | NVARCHAR(3) | string | NOT NULL, Default: 'JPY' | 通貨単位 (ISO 4217) |
| 説明 | Description | NVARCHAR(200) | string | - | 支払いの詳細説明 |
| 支払い日 | PaymentDate | DATE | DateTime | NOT NULL | 支払いが発生した日 |
| 領収書画像 | ReceiptImage | NVARCHAR(MAX) | string | - | 画像URLまたはファイル名 |

### 2.6 Settlements (精算)
物理名: `Settlements`

| 論理名 | 物理名 | データ型 (SQL) | C#型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 精算記録ID | SettlementId | UNIQUEIDENTIFIER | Guid | PK, NOT NULL | 精算一意ID |
| 旅行ID | TripId | UNIQUEIDENTIFIER | Guid | FK (Trips.TripId), NOT NULL | 精算が紐づく旅行ID |
| 出金者ID | FromUserId | UNIQUEIDENTIFIER | Guid | FK (Users.UserId), NOT NULL | 支払うユーザー |
| 受金者ID | ToUserId | UNIQUEIDENTIFIER | Guid | FK (Users.UserId), NOT NULL | 受け取るユーザー |
| 金額 | Amount | DECIMAL(18,2) | decimal | NOT NULL | 精算額 |
| 精算方法 | SettlementMethod | NVARCHAR(50) | string | - | 方法 (Cash, Transfer, etc) |
| ステータス | Status | NVARCHAR(20) | string | NOT NULL | 状態 (Pending, Completed) |
| 完了日時 | CompletedAt | DATETIMEOFFSET | DateTimeOffset? | - | 精算が完了した日時 |

## 3. インデックス設計

| テーブル名 | インデックス名 | カラム名 | 種類 | 目的 |
| :--- | :--- | :--- | :--- | :--- |
| Users | IX_Users_Email | Email | Unique | 高速検索と重複防止 |
| Trips | IX_Trips_CreatedBy | CreatedBy | Non-Clustered | ユーザーごとの旅行一覧取得 |
| TripMembers | IX_TripMembers_TripId | TripId | Non-Clustered | 旅行ごとのメンバー取得 |
| TripMembers | IX_TripMembers_UserId | UserId | Non-Clustered | ユーザーごとの参加旅行取得 |
| Payments | IX_Payments_TripId | TripId | Non-Clustered | 旅行ごとの支払い履歴取得 |
| Settlements | IX_Settlements_TripId | TripId | Non-Clustered | 旅行ごとの精算状況取得 |
