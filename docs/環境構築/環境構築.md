# 環境構築手順

## 1. 前提
- OS: Windows 10/11 (winget 利用推奨) または Ubuntu 20.04 (WSL 含む)
- 権限: 管理者権限または sudo 実行可能
- ポート: 5000 を API で使用、5432 を PostgreSQL で使用

## 2. PostgreSQL のインストール
### Windows
1. [PostgreSQL 公式サイト](https://www.postgresql.org/download/windows/)からインストーラーをダウンロードし、インストールします。
   - `postgres` ユーザーのパスワードは `postgres` と設定してください（開発環境用）。
2. `psql` コマンドが使用できるように、インストール先の `bin` フォルダ（例: `C:\Program Files\PostgreSQL\16\bin`）を環境変数 `Path` に追加します。

### Ubuntu
```bash
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib -y
sudo service postgresql start
# パスワード設定 (開発環境用: postgres/postgres)
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres';"
```

## 3. .NET SDK & 開発ツールのインストール
### Windows (winget)
```powershell
# .NET SDK 8.0
winget install Microsoft.DotNet.SDK.8
# EF Core ツール
dotnet tool install --global dotnet-ef --version 8.0.0
```

### Ubuntu
```bash
sudo apt-get update -y
sudo apt-get install -y wget gpg apt-transport-https
wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb
sudo dpkg -i /tmp/packages-microsoft-prod.deb
sudo apt-get update -y
sudo apt-get install -y dotnet-sdk-8.0
```

## 4. データベースの初期化
本プロジェクトでは Entity Framework Core を使用しています。以下の手順でデータベースを作成し、テーブルを生成します。

1. **DBの作成**:
   PostgreSQL サービスが起動している状態で、リポジトリルートから以下を実行します。
   ```powershell
   .\scripts\db\setup_db.bat
   ```
2. **マイグレーション適用 (テーブル生成)**:
   ```powershell
   dotnet ef database update --project src/Infrastructure --startup-project src/Api --context ApplicationDbContext
   ```

## 5. Node.js & Angular CLI のインストール (フロントエンド開発用)
### Windows
```powershell
# Node.js (LTS)
winget install OpenJS.NodeJS.LTS
# Angular CLI
npm install -g @angular/cli@17
```

### Ubuntu
```bash
# Node.js (nvm経由推奨)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install 20
# Angular CLI
npm install -g @angular/cli@17
```

## 6. リポジトリの取得とビルド
```bash
git clone <your-repo-url> travel_payment
cd travel_payment

# バックエンドビルド
dotnet build TravelPayment.sln

# フロントエンド依存関係インストール
cd src/Web
npm install
```

## 7. 実行方法
### バックエンド (API)
```bash
dotnet run --project src/API/API.csproj --urls http://0.0.0.0:5000
```
- ヘルスチェック: `http://localhost:5000/health`
- Swagger UI: `http://localhost:5000/swagger`

### フロントエンド (Angular)
```bash
cd src/Web
npm start
```
- デバッグ実行: `http://localhost:4200`

## 9. Docker による一括起動
Docker を利用すると、データベース、API、Web 全てを以下のコマンドのみで起動できます。

```bash
docker-compose up --build
```
- Web: `http://localhost`
- API (Swagger): `http://localhost:8080/swagger`

## 10. E2E テストの実行 (Playwright)
ブラウザを介した一連の動作検証を自動で実行します。

```bash
cd tests/E2eTests
npm install
npx playwright install
npx playwright test
```
- ※ アプリケーションが `http://localhost:4200` で稼働している必要があります。

## 11. よくあるエラーと対処
- **dotnet-ef が見つからない**: `dotnet tool install --global dotnet-ef` を実行し、ターミナルを再起動してください。
- **データベース接続エラー**: `appsettings.json` の接続文字列と PostgreSQL の稼働状況を確認してください。
- **Swaggerが 500 エラー**: `dotnet ef database update` が正常に完了しているか確認してください。
- **Docker 起動時に API が DB に接続できない**: DB の初期化を待つため、数秒おいてから再度 `docker-compose up` をお試しください。
