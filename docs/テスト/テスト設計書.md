# 旅行支払い精算アプリ テスト設計書

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのテスト戦略と実装方針を定義する

### 1.2 テスト原則
- **テストファースト**: テスト駆動開発（TDD）の採用
- **自動化優先**: 可能な限りテストを自動化
- **継続的テスト**: CI/CD パイプラインでの継続的テスト実行
- **品質保証**: ソフトウェアの品質と信頼性の確保

## 2. テスト戦略

### 2.1 テストピラミッド

```
        ┌─────────────┐
        │   E2E Tests │ ← 少数・高価格
        └─────────────┘
    ┌─────────────────────┐
    │ Integration Tests   │ ← 中程度・中価格
    └─────────────────────┘
┌─────────────────────────────┐
│      Unit Tests             │ ← 多数・低価格
└─────────────────────────────┘
```

### 2.2 テストの種類と比率

| テスト種類 | 比率 | 実行頻度 | 実行時間 | 目的 |
|-----------|------|----------|----------|------|
| ユニットテスト | 70% | 毎回 | 数秒 | 個別機能の動作確認 |
| 統合テスト | 20% | コミット時 | 数分 | コンポーネント間の連携確認 |
| E2Eテスト | 10% | デプロイ時 | 数十分 | 全体システムの動作確認 |

## 3. ユニットテスト

### 3.1 テストフレームワーク

#### 3.1.1 主要ツール
- **xUnit**: テストフレームワーク
- **Moq**: モックライブラリ
- **FluentAssertions**: アサーションライブラリ
- **AutoFixture**: テストデータ生成

#### 3.1.2 プロジェクト構成
```
TravelPayment.Tests/
├── TravelPayment.Domain.Tests/           # ドメイン層テスト
├── TravelPayment.Application.Tests/      # アプリケーション層テスト
├── TravelPayment.Infrastructure.Tests/  # インフラ層テスト
└── TravelPayment.API.Tests/             # API層テスト
```

### 3.2 ドメイン層テスト

#### 3.2.1 エンティティテスト
```csharp
public class TripTests
{
    [Fact]
    public void Constructor_WithValidData_ShouldCreateTrip()
    {
        // Arrange
        var tripName = "沖縄旅行";
        var description = "美ら海水族館に行く旅行";
        var startDate = DateTime.Today.AddDays(7);
        var endDate = DateTime.Today.AddDays(10);
        var budget = 50000m;
        var createdById = Guid.NewGuid();
        
        // Act
        var trip = new Trip(tripName, description, startDate, endDate, budget, createdById);
        
        // Assert
        trip.TripName.Should().Be(tripName);
        trip.Description.Should().Be(description);
        trip.StartDate.Should().Be(startDate);
        trip.EndDate.Should().Be(endDate);
        trip.Budget.Should().Be(budget);
        trip.CreatedById.Should().Be(createdById);
        trip.Status.Should().Be(TripStatus.Planning);
        trip.Members.Should().NotBeNull();
        trip.Payments.Should().NotBeNull();
        trip.Settlements.Should().NotBeNull();
    }
    
    [Fact]
    public void Constructor_WithInvalidDates_ShouldThrowArgumentException()
    {
        // Arrange
        var tripName = "沖縄旅行";
        var description = "美ら海水族館に行く旅行";
        var startDate = DateTime.Today.AddDays(10);
        var endDate = DateTime.Today.AddDays(7); // 開始日より前
        var budget = 50000m;
        var createdById = Guid.NewGuid();
        
        // Act & Assert
        Action act = () => new Trip(tripName, description, startDate, endDate, budget, createdById);
        act.Should().Throw<ArgumentException>().WithMessage("*開始日は終了日より前である必要があります*");
    }
    
    [Fact]
    public void AddMember_WithValidUser_ShouldAddMember()
    {
        // Arrange
        var trip = CreateValidTrip();
        var user = CreateValidUser();
        var role = TripRole.Member;
        
        // Act
        trip.AddMember(user, role);
        
        // Assert
        trip.Members.Should().HaveCount(2); // 作成者 + 新メンバー
        var addedMember = trip.Members.FirstOrDefault(m => m.UserId == user.Id);
        addedMember.Should().NotBeNull();
        addedMember.Role.Should().Be(role);
        addedMember.IsActive.Should().BeTrue();
    }
    
    [Fact]
    public void AddMember_WithExistingUser_ShouldThrowInvalidOperationException()
    {
        // Arrange
        var trip = CreateValidTrip();
        var user = CreateValidUser();
        trip.AddMember(user, TripRole.Member);
        
        // Act & Assert
        Action act = () => trip.AddMember(user, TripRole.Member);
        act.Should().Throw<InvalidOperationException>().WithMessage("*既に参加しているユーザーです*");
    }
    
    [Fact]
    public void CalculateTotalPayments_WithPayments_ShouldReturnCorrectTotal()
    {
        // Arrange
        var trip = CreateValidTrip();
        var user = CreateValidUser();
        trip.AddMember(user, TripRole.Member);
        
        // 支払い記録を追加
        var payment1 = new Payment(trip.Id, user.Id, Guid.NewGuid(), 1000m, "電車賃", DateTime.Today);
        var payment2 = new Payment(trip.Id, user.Id, Guid.NewGuid(), 2000m, "昼食", DateTime.Today);
        
        // Act
        var total = trip.CalculateTotalPayments();
        
        // Assert
        total.Should().Be(3000m);
    }
    
    private Trip CreateValidTrip()
    {
        return new Trip(
            "沖縄旅行",
            "美ら海水族館に行く旅行",
            DateTime.Today.AddDays(7),
            DateTime.Today.AddDays(10),
            50000m,
            Guid.NewGuid()
        );
    }
    
    private User CreateValidUser()
    {
        return new User(
            "testuser",
            "test@example.com",
            "hashedpassword"
        );
    }
}
```

#### 3.2.2 値オブジェクトテスト
```csharp
public class MoneyTests
{
    [Fact]
    public void Constructor_WithValidAmount_ShouldCreateMoney()
    {
        // Arrange & Act
        var money = new Money(1000m, "JPY");
        
        // Assert
        money.Amount.Should().Be(1000m);
        money.Currency.Should().Be("JPY");
    }
    
    [Fact]
    public void Constructor_WithNegativeAmount_ShouldThrowArgumentException()
    {
        // Act & Assert
        Action act = () => new Money(-1000m, "JPY");
        act.Should().Throw<ArgumentException>().WithMessage("*金額は0以上である必要があります*");
    }
    
    [Fact]
    public void ConvertTo_SameCurrency_ShouldReturnSameInstance()
    {
        // Arrange
        var money = new Money(1000m, "JPY");
        
        // Act
        var converted = money.ConvertTo("JPY", 1.0m);
        
        // Assert
        converted.Should().BeSameAs(money);
    }
    
    [Fact]
    public void ConvertTo_DifferentCurrency_ShouldReturnNewInstance()
    {
        // Arrange
        var money = new Money(1000m, "JPY");
        var exchangeRate = 0.009m; // 1 JPY = 0.009 USD
        
        // Act
        var converted = money.ConvertTo("USD", exchangeRate);
        
        // Assert
        converted.Should().NotBeSameAs(money);
        converted.Amount.Should().Be(9m);
        converted.Currency.Should().Be("USD");
    }
    
    [Fact]
    public void Equals_SameValues_ShouldReturnTrue()
    {
        // Arrange
        var money1 = new Money(1000m, "JPY");
        var money2 = new Money(1000m, "JPY");
        
        // Act & Assert
        money1.Should().Be(money2);
    }
    
    [Fact]
    public void Equals_DifferentValues_ShouldReturnFalse()
    {
        // Arrange
        var money1 = new Money(1000m, "JPY");
        var money2 = new Money(2000m, "JPY");
        
        // Act & Assert
        money1.Should().NotBe(money2);
    }
}
```

### 3.3 アプリケーション層テスト

#### 3.3.0 テストデータ生成の効率化
テストデータ生成ツールとして挙げられている AutoFixture を活用することで、テストのセットアップコードを大幅に簡潔にできます。特に、Moqと連携させることで、依存オブジェクトのモック生成を自動化し、テストコードの可読性と保守性を向上させます。

例: AutoFixtureとMoqの連携
```csharp 
var fixture = new Fixture(); +fixture.Customize(new AutoMoqCustomization());

// 依存関係（リポジトリ等）が自動的にモック化されたサービスインスタンスを生成
var tripService = fixture.Create();

// 個別のモック設定も可能
fixture.Freeze<Mock>()

.Setup(x => x.GetByIdAsync(It.IsAny()))
.ReturnsAsync((User)null);
```

#### 3.3.1 サービステスト
```csharp
public class TripServiceTests
{
    private Mock<ITripRepository> _tripRepositoryMock;
    private Mock<IUserRepository> _userRepositoryMock;
    private Mock<ITripMemberRepository> _memberRepositoryMock;
    private Mock<IUnitOfWork> _unitOfWorkMock;
    private Mock<IMapper> _mapperMock;
    private TripService _tripService;
    
    public void Setup()
    {
        _tripRepositoryMock = new Mock<ITripRepository>();  // AutoFixtureの活用を推奨
        _userRepositoryMock = new Mock<IUserRepository>();
        _memberRepositoryMock = new Mock<ITripMemberRepository>();
        _unitOfWorkMock = new Mock<IUnitOfWork>();
        _mapperMock = new Mock<IMapper>();
        
        _tripService = new TripService(
            _tripRepositoryMock.Object,
            _userRepositoryMock.Object,
            _memberRepositoryMock.Object,
            _unitOfWorkMock.Object,
            _mapperMock.Object
        );
    }
    
    [Fact]
    public async Task CreateTripAsync_WithValidData_ShouldCreateTrip()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var dto = new CreateTripDto
        {
            TripName = "沖縄旅行",
            Description = "美ら海水族館に行く旅行",
            StartDate = DateTime.Today.AddDays(7),
            EndDate = DateTime.Today.AddDays(10),
            Budget = 50000m,
            MemberEmails = new[] { "member@example.com" }
        };
        
        var user = CreateValidUser(userId);
        var member = CreateValidUser(Guid.NewGuid());
        var trip = CreateValidTrip();
        var tripDto = new TripDto { TripId = trip.Id, TripName = trip.TripName };
        
        _userRepositoryMock.Setup(x => x.GetByIdAsync(userId))
            .ReturnsAsync(user);
        _userRepositoryMock.Setup(x => x.GetByEmailAsync("member@example.com"))
            .ReturnsAsync(member);
        _mapperMock.Setup(x => x.Map<TripDto>(It.IsAny<Trip>()))
            .Returns(tripDto);
        
        // Act
        var result = await _tripService.CreateTripAsync(dto, userId);
        
        // Assert
        result.Should().NotBeNull();
        result.TripId.Should().Be(trip.Id);
        result.TripName.Should().Be(trip.TripName);
        
        _tripRepositoryMock.Verify(x => x.Add(It.IsAny<Trip>()), Times.Once);
        _unitOfWorkMock.Verify(x => x.SaveChangesAsync(), Times.Once);
    }
    
    [Fact]
    public async Task CreateTripAsync_WhenUserNotFound_ShouldThrowNotFoundException()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var dto = new CreateTripDto
        {
            TripName = "沖縄旅行",
            StartDate = DateTime.Today.AddDays(7),
            EndDate = DateTime.Today.AddDays(10)
        };
        
        _userRepositoryMock.Setup(x => x.GetByIdAsync(userId))
            .ReturnsAsync((User)null);
        
        // Act & Assert
        Func<Task> act = () => _tripService.CreateTripAsync(dto, userId);
        await act.Should().ThrowAsync<NotFoundException>()
            .WithMessage("ユーザーが見つかりません");
    }
    
    [Fact]
    public async Task GetTripAsync_WhenTripExists_ShouldReturnTrip()
    {
        // Arrange
        var tripId = Guid.NewGuid();
        var userId = Guid.NewGuid();
        var trip = CreateValidTrip();
        var tripDto = new TripDto { TripId = trip.Id, TripName = trip.TripName };
        
        _tripRepositoryMock.Setup(x => x.GetByIdWithMembersAsync(tripId))
            .ReturnsAsync(trip);
        _mapperMock.Setup(x => x.Map<TripDto>(trip))
            .Returns(tripDto);
        
        // Act
        var result = await _tripService.GetTripAsync(tripId, userId);
        
        // Assert
        result.Should().NotBeNull();
        result.TripId.Should().Be(trip.Id);
    }
    
    private User CreateValidUser(Guid userId)
    {
        var user = new User("testuser", "test@example.com", "hashedpassword");
        // リフレクションを使用してIDを設定
        var idProperty = typeof(User).GetProperty("Id");
        idProperty.SetValue(user, userId);
        return user;
    }
    
    private Trip CreateValidTrip()
    {
        return new Trip(
            "沖縄旅行",
            "美ら海水族館に行く旅行",
            DateTime.Today.AddDays(7),
            DateTime.Today.AddDays(10),
            50000m,
            Guid.NewGuid()
        );
    }
}
```

## 4. 統合テスト

### 4.1 データベース統合テスト

#### 4.1.1 テストデータベース設定
```csharp
public class TripRepositoryIntegrationTests
{
    private TravelPaymentDbContext _context;
    private ITripRepository _tripRepository;
    
    public TripRepositoryIntegrationTests()
    {
        var options = new DbContextOptionsBuilder<TravelPaymentDbContext>()
            .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
            .Options;
            
        _context = new TravelPaymentDbContext(options);
        _tripRepository = new TripRepository(_context);
    }
    
    // xUnitではIDisposableを実装してリソースを破棄するのが一般的
    public void Cleanup()
    {
        _context.Dispose();
    }
    
    [Fact]
    public async Task GetByIdAsync_WithExistingTrip_ShouldReturnTrip()
    {
        // Arrange
        var tripId = Guid.NewGuid();
        var trip = CreateTestTrip(tripId);
        await SeedTestDataAsync();
        _context.Trips.Add(trip);
        await _context.SaveChangesAsync();
        
        // Act
        var result = await _tripRepository.GetByIdAsync(tripId);
        
        // Assert
        result.Should().NotBeNull();
        result.Id.Should().Be(tripId);
        result.TripName.Should().Be("沖縄旅行");
    }
    
    [Fact]
    public async Task GetByIdAsync_WithNonExistentTrip_ShouldReturnNull()
    {
        // Arrange
        var nonExistentId = Guid.NewGuid();
        
        // Act
        var result = await _tripRepository.GetByIdAsync(nonExistentId);
        
        // Assert
        result.Should().BeNull();
    }
    
    [Fact]
    public async Task GetByUserIdAsync_WithValidUser_ShouldReturnTrips()
    {
        // Arrange
        var userId = Guid.NewGuid();
        await SeedTestDataAsync();
        var trip1 = CreateTestTrip(Guid.NewGuid());
        var trip2 = CreateTestTrip(Guid.NewGuid());
        
        var member1 = new TripMember(trip1.Id, userId, TripRole.Admin);
        var member2 = new TripMember(trip2.Id, userId, TripRole.Member);
        
        _context.Trips.AddRange(trip1, trip2);
        _context.TripMembers.AddRange(member1, member2);
        await _context.SaveChangesAsync();
        
        // Act
        var result = await _tripRepository.GetByUserIdAsync(userId);
        
        // Assert
        result.Should().HaveCount(2);
        result.Should().Contain(t => t.Id == trip1.Id);
        result.Should().Contain(t => t.Id == trip2.Id);
    }
    
    private async Task SeedTestDataAsync()
    {
        // カテゴリデータの準備
        var categories = new[]
        {
            new Category("交通費", "電車、バス、タクシー等", "directions_car", "#2196F3"),
            new Category("宿泊費", "ホテル、旅館、民宿等", "hotel", "#4CAF50"),
            new Category("食費", "食事、飲み物、お土産等", "restaurant", "#FF9800")
        };
        _context.Categories.AddRange(categories);
        await _context.SaveChangesAsync();
    }
    
    private Trip CreateTestTrip(Guid tripId)
    {
        var trip = new Trip(
            "沖縄旅行",
            "美ら海水族館に行く旅行",
            DateTime.Today.AddDays(7),
            DateTime.Today.AddDays(10),
            50000m,
            Guid.NewGuid()
        );
        
        // リフレクションを使用してIDを設定
        var idProperty = typeof(Trip).GetProperty("Id");
        idProperty.SetValue(trip, tripId);
        
        return trip;
    }
}
```

### 4.2 API統合テスト

#### 4.2.1 WebApplicationFactory を使用したテスト
```csharp
public class TripControllerIntegrationTests
{
    private WebApplicationFactory<Program> _factory;
    private HttpClient _client;
    
    public void Setup()
    {
        _factory = new WebApplicationFactory<Program>()
            .WithWebHostBuilder(builder =>
            {
                builder.ConfigureAppConfiguration((context, config) =>
                {
                    // テスト用の設定ファイルを追加
                    config.AddJsonFile("appsettings.testing.json", optional: false);
                });
                
                builder.ConfigureServices(services =>
                {
                    // テスト用のサービスを登録
                    var descriptor = services.SingleOrDefault(
                        d => d.ServiceType == typeof(DbContextOptions<TravelPaymentDbContext>));
                    if (descriptor != null)
                        services.Remove(descriptor);
                    
                    services.AddDbContext<TravelPaymentDbContext>(options =>
                    {
                        options.UseInMemoryDatabase("TestDatabase");
                    });
                });
            });
        
        _client = _factory.CreateClient();
    }
    
    public void Cleanup()
    {
        _client.Dispose();
        _factory.Dispose();
    }
    
    [Fact]
    public async Task GetTrips_WithoutAuthentication_ShouldReturnUnauthorized()
    {
        // Act
        var response = await _client.GetAsync("/api/trips");
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);
    }
    
    [Fact]
    public async Task GetTrips_WithValidToken_ShouldReturnTrips()
    {
        // Arrange
        var user = await CreateTestUserAsync();
        var token = await GetAuthTokenAsync(user);
        _client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        
        var trip = await CreateTestTripAsync(user.Id);
        
        // Act
        var response = await _client.GetAsync("/api/trips");
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.OK);
        
        var content = await response.Content.ReadAsStringAsync();
        var result = JsonSerializer.Deserialize<ApiResponse<PagedResult<TripDto>>>(content);
        result.Success.Should().BeTrue();
        result.Data.Trips.Should().HaveCount(1);
        result.Data.Trips.First().TripName.Should().Be("沖縄旅行");
    }
    
    [Fact]
    public async Task CreateTrip_WithValidData_ShouldCreateTrip()
    {
        // Arrange
        var user = await CreateTestUserAsync();
        var token = await GetAuthTokenAsync(user);
        _client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        
        var createTripDto = new CreateTripDto
        {
            TripName = "北海道旅行",
            Description = "札幌でラーメンを食べる旅行",
            StartDate = DateTime.Today.AddDays(14),
            EndDate = DateTime.Today.AddDays(17),
            Budget = 80000m
        };
        
        var json = JsonSerializer.Serialize(createTripDto);
        var content = new StringContent(json, Encoding.UTF8, "application/json");
        
        // Act
        var response = await _client.PostAsync("/api/trips", content);
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Created);
        
        var responseContent = await response.Content.ReadAsStringAsync();
        var result = JsonSerializer.Deserialize<ApiResponse<CreateTripResponse>>(responseContent);
        result.Success.Should().BeTrue();
        result.Message.Should().Be("旅行が作成されました");
        result.Data.TripId.Should().NotBeEmpty();
        result.Data.TripName.Should().Be("北海道旅行");
    }
    
    private async Task<User> CreateTestUserAsync()
    {
        // テストユーザーの作成処理
        // 実際の実装では、テスト用のユーザー作成サービスを使用
        throw new NotImplementedException();
    }
    
    private async Task<string> GetAuthTokenAsync(User user)
    {
        // 認証トークンの取得処理
        // 実際の実装では、テスト用の認証サービスを使用
        throw new NotImplementedException();
    }
    
    private async Task<Trip> CreateTestTripAsync(Guid userId)
    {
        // テスト旅行の作成処理
        // 実際の実装では、テスト用の旅行作成サービスを使用
        throw new NotImplementedException();
    }
}
```

## 5. E2Eテスト

### 5.1 Playwright を使用したE2Eテスト

#### 5.1.1 テスト設定
```csharp
public class TripE2ETests
{
    private IPlaywright _playwright;
    private IBrowser _browser;
    private IPage _page;
    
    public async Task Setup()
    {
        _playwright = await Playwright.CreateAsync();
        _browser = await _playwright.Chromium.LaunchAsync(new BrowserTypeLaunchOptions
        {
            Headless = false // テスト実行中にブラウザを表示
        });
        _page = await _browser.NewPageAsync();
    }
    
    public async Task Cleanup()
    {
        await _page.CloseAsync();
        await _browser.CloseAsync();
        _playwright.Dispose();
    }
    
    [Fact]
    public async Task CreateTrip_CompleteFlow_ShouldCreateTripSuccessfully()
    {
        // Arrange
        await _page.GotoAsync("http://localhost:4200");
        
        // ログイン
        await _page.ClickAsync("[data-testid='login-button']");
        await _page.FillAsync("[data-testid='email-input']", "test@example.com");
        await _page.FillAsync("[data-testid='password-input']", "password123");
        await _page.ClickAsync("[data-testid='submit-login-button']");
        
        // ログイン完了を待機
        await _page.WaitForSelectorAsync("[data-testid='dashboard']");
        
        // 旅行作成ボタンをクリック
        await _page.ClickAsync("[data-testid='create-trip-button']");
        
        // 旅行情報を入力
        await _page.FillAsync("[data-testid='trip-name-input']", "沖縄旅行");
        await _page.FillAsync("[data-testid='trip-description-input']", "美ら海水族館に行く旅行");
        await _page.FillAsync("[data-testid='start-date-input']", DateTime.Today.AddDays(7).ToString("yyyy-MM-dd"));
        await _page.FillAsync("[data-testid='end-date-input']", DateTime.Today.AddDays(10).ToString("yyyy-MM-dd"));
        await _page.FillAsync("[data-testid='budget-input']", "50000");
        
        // 旅行を作成
        await _page.ClickAsync("[data-testid='submit-trip-button']");
        
        // 作成完了を待機
        await _page.WaitForSelectorAsync("[data-testid='trip-created-success']");
        
        // 旅行一覧に戻る
        await _page.ClickAsync("[data-testid='back-to-trips-button']");
        
        // 作成した旅行が表示されることを確認
        var tripElement = await _page.QuerySelectorAsync("text=沖縄旅行");
        tripElement.Should().NotBeNull();
    }
    
    [Fact]
    public async Task AddPayment_ToExistingTrip_ShouldAddPaymentSuccessfully()
    {
        // Arrange
        await _page.GotoAsync("http://localhost:4200");
        await LoginAsync();
        
        // 既存の旅行を選択
        await _page.ClickAsync("text=沖縄旅行");
        
        // 支払い追加ボタンをクリック
        await _page.ClickAsync("[data-testid='add-payment-button']");
        
        // 支払い情報を入力
        await _page.FillAsync("[data-testid='payment-amount-input']", "1000");
        await _page.FillAsync("[data-testid='payment-description-input']", "電車賃");
        await _page.SelectOptionAsync("[data-testid='payment-category-select']", "交通費");
        await _page.FillAsync("[data-testid='payment-date-input']", DateTime.Today.ToString("yyyy-MM-dd"));
        
        // 支払いを追加
        await _page.ClickAsync("[data-testid='submit-payment-button']");
        
        // 追加完了を待機
        await _page.WaitForSelectorAsync("[data-testid='payment-added-success']");
        
        // 支払い一覧に戻る
        await _page.ClickAsync("[data-testid='back-to-payments-button']");
        
        // 追加した支払いが表示されることを確認
        var paymentElement = await _page.QuerySelectorAsync("text=電車賃");
        paymentElement.Should().NotBeNull();
    }
    
    private async Task LoginAsync()
    {
        await _page.ClickAsync("[data-testid='login-button']");
        await _page.FillAsync("[data-testid='email-input']", "test@example.com");
        await _page.FillAsync("[data-testid='password-input']", "password123");
        await _page.ClickAsync("[data-testid='submit-login-button']");
        await _page.WaitForSelectorAsync("[data-testid='dashboard']");
    }
}
```

## 6. パフォーマンステスト

### 6.1 負荷テスト

#### 6.1.1 NBomber を使用した負荷テスト
```csharp
public class TripApiPerformanceTests
{
    [Fact]
    public async Task GetTrips_UnderLoad_ShouldHandleConcurrentRequests()
    {
        var scenario = ScenarioBuilder.CreateScenario("Get Trips Load Test", async context =>
        {
            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("http://localhost:5000");
            
            // 認証トークンを取得
            var loginData = new { email = "test@example.com", password = "password123" };
            var loginResponse = await httpClient.PostAsJsonAsync("/api/auth/login", loginData);
            var loginResult = await loginResponse.Content.ReadFromJsonAsync<AuthResult>();
            
            httpClient.DefaultRequestHeaders.Authorization = 
                new AuthenticationHeaderValue("Bearer", loginResult.Token);
            
            // 旅行一覧を取得
            var response = await httpClient.GetAsync("/api/trips");
            
            if (response.IsSuccessStatusCode)
            {
                context.MarkAsOk();
            }
            else
            {
                context.MarkAsFail();
            }
        })
        .WithLoadSimulations(
            Simulation.Inject(rate: 100, interval: TimeSpan.FromSeconds(1), during: TimeSpan.FromMinutes(1))
        );
        
        NBomberRunner
            .RegisterScenarios(scenario)
            .Run();
    }
    
    [Fact]
    public async Task CreateTrip_UnderLoad_ShouldHandleConcurrentRequests()
    {
        var scenario = ScenarioBuilder.CreateScenario("Create Trip Load Test", async context =>
        {
            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("http://localhost:5000");
            
            // 認証トークンを取得
            var loginData = new { email = "test@example.com", password = "password123" };
            var loginResponse = await httpClient.PostAsJsonAsync("/api/auth/login", loginData);
            var loginResult = await loginResponse.Content.ReadFromJsonAsync<AuthResult>();
            
            httpClient.DefaultRequestHeaders.Authorization = 
                new AuthenticationHeaderValue("Bearer", loginResult.Token);
            
            // 旅行を作成
            var tripData = new
            {
                tripName = $"Test Trip {Guid.NewGuid()}",
                description = "Performance test trip",
                startDate = DateTime.Today.AddDays(7).ToString("yyyy-MM-dd"),
                endDate = DateTime.Today.AddDays(10).ToString("yyyy-MM-dd"),
                budget = 50000
            };
            
            var response = await httpClient.PostAsJsonAsync("/api/trips", tripData);
            
            if (response.IsSuccessStatusCode)
            {
                context.MarkAsOk();
            }
            else
            {
                context.MarkAsFail();
            }
        })
        .WithLoadSimulations(
            Simulation.Inject(rate: 50, interval: TimeSpan.FromSeconds(1), during: TimeSpan.FromMinutes(1))
        );
        
        NBomberRunner
            .RegisterScenarios(scenario)
            .Run();
    }
}
```

## 7. セキュリティテスト

### 7.1 認証・認可テスト

```csharp
public class SecurityTests
{
    private WebApplicationFactory<Program> _factory;
    private HttpClient _client;
    
    public void Setup()
    {
        _factory = new WebApplicationFactory<Program>();
        _client = _factory.CreateClient();
    }
    
    [Fact]
    public async Task Login_WithInvalidCredentials_ShouldNotRevealUserExistence()
    {
        // Arrange
        var invalidCredentials = new { email = "nonexistent@example.com", password = "wrongpassword" };
        var content = new StringContent(JsonSerializer.Serialize(invalidCredentials), Encoding.UTF8, "application/json");
        
        // Act
        var response = await _client.PostAsync("/api/auth/login", content);
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);
        
        var responseContent = await response.Content.ReadAsStringAsync();
        var result = JsonSerializer.Deserialize<ErrorResponse>(responseContent);
        result.Message.Should().Be("メールアドレスまたはパスワードが正しくありません");
    }
    
    [Fact]
    public async Task Trip_WithoutAuthentication_ShouldReturnUnauthorized()
    {
        // Act
        var response = await _client.GetAsync("/api/trips");
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);
    }
    
    [Fact]
    public async Task Trip_WithInsufficientPermissions_ShouldReturnForbidden()
    {
        // Arrange
        var user = await CreateTestUserAsync();
        var token = await GetAuthTokenAsync(user);
        _client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        
        var trip = await CreateTestTripAsync(user.Id);
        var otherUser = await CreateTestUserAsync();
        var otherToken = await GetAuthTokenAsync(otherUser);
        _client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", otherToken);
        
        // Act
        var response = await _client.DeleteAsync($"/api/trips/{trip.Id}");
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Forbidden);
    }
}
```

## 8. テストデータ管理

### 8.1 テストデータファクトリ

```csharp
public static class TestDataFactory
{
    public static User CreateUser(string username = "testuser", string email = "test@example.com")
    {
        return new User(username, email, "hashedpassword");
    }
    
    public static Trip CreateTrip(string tripName = "沖縄旅行", Guid? createdById = null)
    {
        return new Trip(
            tripName,
            "テスト旅行",
            DateTime.Today.AddDays(7),
            DateTime.Today.AddDays(10),
            50000m,
            createdById ?? Guid.NewGuid()
        );
    }
    
    public static Payment CreatePayment(Guid tripId, Guid paidById, decimal amount = 1000m)
    {
        return new Payment(
            tripId,
            paidById,
            Guid.NewGuid(), // カテゴリID
            amount,
            "テスト支払い",
            DateTime.Today
        );
    }
    
    public static Category CreateCategory(string name = "交通費")
    {
        return new Category(name, "テストカテゴリ", "icon", "#000000");
    }
}
```

### 8.2 テストデータベースの管理

```csharp
public class TestDatabaseManager
{
    private readonly TravelPaymentDbContext _context;
    
    public TestDatabaseManager(TravelPaymentDbContext context)
    {
        _context = context;
    }
    
    public async Task CleanupAsync()
    {
        _context.Trips.RemoveRange(_context.Trips);
        _context.Users.RemoveRange(_context.Users);
        _context.Payments.RemoveRange(_context.Payments);
        _context.Categories.RemoveRange(_context.Categories);
        _context.TripMembers.RemoveRange(_context.TripMembers);
        _context.Settlements.RemoveRange(_context.Settlements);
        _context.UserSessions.RemoveRange(_context.UserSessions);
        
        await _context.SaveChangesAsync();
    }
    
    public async Task SeedAsync()
    {
        // 基本カテゴリの作成
        var categories = new[]
        {
            new Category("交通費", "電車、バス、タクシー等", "directions_car", "#2196F3"),
            new Category("宿泊費", "ホテル、旅館、民宿等", "hotel", "#4CAF50"),
            new Category("食費", "食事、飲み物、お土産等", "restaurant", "#FF9800"),
            new Category("娯楽費", "観光、アクティビティ、ショー等", "attractions", "#9C27B0"),
            new Category("買い物", "お土産、記念品等", "shopping_bag", "#E91E63"),
            new Category("その他", "その他の費用", "more_horiz", "#607D8B")
        };
        
        _context.Categories.AddRange(categories);
        await _context.SaveChangesAsync();
    }
}
```

## 9. CI/CD パイプライン

### 9.1 GitHub Actions でのテスト実行

```yaml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore
    
    - name: Run unit tests
      run: dotnet test --no-build --verbosity normal --collect:"XPlat Code Coverage"
    
    - name: Run integration tests
      run: dotnet test --no-build --verbosity normal --filter "Category=Integration"

    # 補足: 上記の `--filter` を機能させるには、統合テストのテストメソッドに
    # xUnitの `[Trait("Category", "Integration")]` 属性を付与する必要があります。
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./**/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
```

## 10. テストメトリクス

### 10.1 テストカバレッジ

- **目標**: 80%以上のコードカバレッジ
- **測定ツール**: Coverlet、Codecov
- **カバレッジ対象**: ビジネスロジック、API エンドポイント

### 10.2 テスト実行時間

- **ユニットテスト**: 30秒以内
- **統合テスト**: 5分以内
- **E2Eテスト**: 15分以内

### 10.3 テスト品質指標

- **テスト成功率**: 95%以上
- **テスト実行頻度**: 毎回のコミット
- **テスト保守性**: テストコードの可読性と保守性

---

*このテスト設計書は開発の進行に応じて更新される場合があります。*
