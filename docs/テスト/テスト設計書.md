# 旅行支払い精算アプリ テスト設計書

## 1. 概要

### 1.1 目的
旅行支払い精算アプリのテスト戦略と実装方針を定義する

### 1.2 テスト原則
- **テストファースト**: テスト駆動開発（TDD）の採用
- **自動化優先**: 可能な限りテストを自動化
- **継続的テスト**: CI/CD パイプラインでの継続的テスト実行
- **品質保証**: ソフトウェアの品質と信頼性の確保

## 2. テスト戦略

### 2.1 テストピラミッド

```
        ┌─────────────┐
        │   E2E Tests │ ← 少数・高価格
        └─────────────┘
    ┌─────────────────────┐
    │ Integration Tests   │ ← 中程度・中価格
    └─────────────────────┘
┌─────────────────────────────┐
│      Unit Tests             │ ← 多数・低価格
└─────────────────────────────┘
```

### 2.2 テストの種類と比率

| テスト種類 | 比率 | 実行頻度 | 実行時間 | 目的 |
|-----------|------|----------|----------|------|
| ユニットテスト | 70% | 毎回 | 数秒 | 個別機能の動作確認 |
| 統合テスト | 20% | コミット時 | 数分 | コンポーネント間の連携確認 |
| E2Eテスト | 10% | デプロイ時 | 数十分 | 全体システムの動作確認 |

## 3. ユニットテスト

ビジネスロジックや個別の機能単位で、期待通りの動作をするか検証します。

### 3.1 テスト方針
- **対象**: ドメインモデル（エンティティ、値オブジェクト）、アプリケーションサービス、バリデーター。
- **手法**: 外部依存（データベース等）をテスト用オブジェクト（モック）に置き換え、ロジックのみを対象に高速に実行します。
- **データ生成**: テストデータのセットアップを効率化するため、自動生成ツールやファクトリパターンを活用します。

### 3.2 主なテスト項目
| カテゴリ | 検証内容 |
| :--- | :--- |
| エンティティ | コンストラクタによる属性設定、日付の前後関係等のバリデーション、ステータス遷移の妥当性。 |
| 値オブジェクト | 等価性比較、不正な値（負の金額等）の入力制限、通貨変換ロジック。 |
| サービス層 | ユースケースに基づいたリポジトリの呼び出し順序、例外発生時のエラーハンドリング。 |
| 共通部品 | ログ出力、例外共通処理、文字列操作等のユーティリティ機能。 |

## 4. 統合テスト

複数のコンポーネントを組み合わせた状態での整合性と通信を検証します。

### 4.1 データベース統合テスト
- **方針**: メモリ内データベース（In-memory）または軽量なテスト用データベースを用い、リポジトリ層とDBのやり取りを検証します。
- **検証内容**: データの保存・取得・削除、複雑な条件による検索クエリの正確性、リレーションシップの解決。

### 4.2 API 統合テスト
- **方針**: インメモリで API サーバーを起動し、HTTP リクエストを送信してレスポンスを検証します。
- **検証内容**: エンドポイントのルーティング、リクエストバリデーション、正しいステータスコードの返却、認証・認可フィルターの動作。

## 5. E2Eテスト

ユーザーの操作フローを模倣し、システム全体の動作をフロントエンドからバックエンドまで一貫して検証します。

- **方針**: ブラウザ自動操作ツール（Playwright 等）を使用し、実際の UI を介したシナリオテストを行います。
- **検証項目**: ログインから旅行作成、支払い登録、精算計算までの一連の主要導線。

## 6. パフォーマンステスト

高負荷時におけるシステムの安定性とレスポンス性能を検証します。

- **方針**: 負荷テストツールを用い、多数の同時接続をシミュレートしてスループットとレイテンシを測定します。
- **検証項目**: API エンドポイントごとの最大同時リクエスト処理能力、データベースクエリのボトルネック調査。

## 7. セキュリティテスト

システムに脆弱性が存在しないか、およびセキュリティポリシーが正しく適用されているか検証します。

- **検証項目**: 認証なしでの API アクセス拒否、他ユーザーリソースへの不正アクセス遮断。
- **手法**: 静的解析（SAST）、動的解析（DAST）、依存関係の脆弱性スキャン。

## 8. テストデータ管理

- **テストデータ・ファクトリ**: 各テストで必要な初期状態を容易に作成するためのユーティリティやパターンを使用します。
- **クリーンアップ**: テスト実行後にデータベースを初期状態（または既知の状態）にリセットし、テスト間の干渉を防止します。

## 9. CI/CD パイプライン

開発工程における継続的な品質確保のため、CI/CD パイプライン内で自動テストを実行します。

- **自動テストのトリガー**: メインブランチや開発ブランチへのプルリクエスト作成、およびマージ時。
- **実行プロセス**:
    1. 環境セットアップ（.NET SDK の構成）。
    2. 依存関係の解決とビルド。
    3. ユニットテストおよび統合テストの実行。
    4. コードカバレッジの測定とレポートの生成。
- **合格基準**: すべての自動テストが成功し、かつ目標カバレッジを満たしていること。

## 10. テストメトリクス

- **テストカバレッジ**: ビジネスロジックを主対象に 80% 以上のカバレッジを目標とします。
- **実行時間**: 開発者の生産性を阻害しないよう、ユニットテストは 30 秒以内、全テストでも合理的な時間内（例: 15分）に完了することを目指します。
- **成功率**: パイプライン上でのテスト成功率 100% を維持します。

---

*このテスト設計書は開発の進行に応じて更新される場合があります。*
